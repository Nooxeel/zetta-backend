// ===========================================================
// SISTEMA DE PAGOS Y COMISIONES - APAPACHO
// ===========================================================
// Este archivo contiene los modelos necesarios para el sistema
// de comisiones (10% estándar, 7% VIP), pagos a creadores,
// y contabilidad de doble partida.
//
// IMPORTANTE: Agregar al schema.prisma existente
// ===========================================================

// -----------------------------------------------------
// ENUMS (para type safety)
// -----------------------------------------------------

enum CreatorTier {
  STANDARD
  VIP
}

enum CreatorStatus {
  ACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum ProductType {
  SUBSCRIPTION
  PPV
  TIP
}

enum TransactionStatus {
  SUCCEEDED
  REFUNDED
  CHARGEDBACK
  DISPUTED
}

enum PayoutStatus {
  CALCULATED
  PENDING
  SENT
  FAILED
  CANCELLED
}

enum PayoutFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum ChargebackStatus {
  RECEIVED
  WON
  LOST
  REVERSED
}

// -----------------------------------------------------
// CAMPOS A AGREGAR AL MODELO Creator EXISTENTE
// -----------------------------------------------------
// Agregar estos campos al modelo Creator:
//
//   tier            CreatorTier    @default(STANDARD)
//   tierEffectiveFrom DateTime     @default(now())
//   status          CreatorStatus  @default(ACTIVE)
//
//   // Relaciones nuevas
//   bankAccounts    CreatorBankAccount[]
//   products        Product[]
//   transactions    Transaction[]
//   payouts         Payout[]
//   tierHistory     CreatorTierHistory[]
//   ledgerEntries   LedgerEntry[]
// -----------------------------------------------------

// -----------------------------------------------------
// NUEVOS MODELOS
// -----------------------------------------------------

// Historial de cambios de tier (auditoría VIP)
model CreatorTierHistory {
  id          String      @id @default(uuid())
  creatorId   String
  creator     Creator     @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  previousTier CreatorTier
  newTier      CreatorTier
  reason       String?     // "PROMOTED_BY_SYSTEM", "DEMOTED_LOW_REVENUE", "ADMIN_OVERRIDE"
  changedBy    String?     // userId del admin o "SYSTEM"
  
  effectiveFrom DateTime   @default(now())
  createdAt     DateTime   @default(now())

  @@index([creatorId])
  @@index([effectiveFrom])
}

// Tarifas de la plataforma (versionadas)
model FeeSchedule {
  id                    String          @id @default(uuid())
  effectiveFrom         DateTime
  
  // Comisiones en basis points (1000 = 10%, 700 = 7%)
  standardPlatformFeeBps Int            @default(1000)
  vipPlatformFeeBps     Int             @default(700)
  
  // Configuración de pagos
  holdDays              Int             @default(7)
  minPayoutClp          BigInt          @default(20000)
  payoutFrequency       PayoutFrequency @default(WEEKLY)
  
  // Metadata
  description           String?
  createdBy             String?
  createdAt             DateTime        @default(now())
  
  // Relación con transacciones que usaron esta tarifa
  transactions          Transaction[]

  @@index([effectiveFrom(sort: Desc)])
}

// Cuentas bancarias de creadores
model CreatorBankAccount {
  id                String   @id @default(uuid())
  creatorId         String
  creator           Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  bankCode          String   // Código banco Chile (001=Banco de Chile, 012=Banco Estado, etc)
  bankName          String   // Nombre legible
  accountType       String   // "CORRIENTE", "VISTA", "AHORRO"
  
  // NOTA: En producción, estos campos deben estar encriptados
  accountNumber     String
  accountHolderName String
  accountHolderRut  String   // Formato: 12.345.678-9
  
  isDefault         Boolean  @default(true)
  isVerified        Boolean  @default(false)
  verifiedAt        DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  deletedAt         DateTime? // Soft delete

  @@index([creatorId])
  @@index([isDefault])
}

// Productos (lo que compra el fan)
model Product {
  id          String      @id @default(uuid())
  creatorId   String
  creator     Creator     @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  type        ProductType
  title       String?
  description String?
  
  // Precio en CLP (BigInt para evitar problemas de precisión)
  priceClp    BigInt
  
  // Metadata adicional (ej: duración suscripción, postId para PPV)
  metadata    Json        @default("{}")
  
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deletedAt   DateTime?   // Soft delete
  
  transactions Transaction[]

  @@index([creatorId])
  @@index([type])
  @@index([isActive])
}

// Transacciones (pagos exitosos)
model Transaction {
  id              String            @id @default(uuid())
  creatorId       String
  creator         Creator           @relation(fields: [creatorId], references: [id])
  
  fanUserId       String
  
  productId       String?
  product         Product?          @relation(fields: [productId], references: [id])
  productType     ProductType
  
  currency        String            @default("CLP")
  
  // Montos en CLP (BigInt)
  grossAmount     BigInt            // Monto bruto pagado por el fan
  
  // Tarifa aplicada (INMUTABLE - no recalcular)
  appliedFeeScheduleId String
  appliedFeeSchedule   FeeSchedule  @relation(fields: [appliedFeeScheduleId], references: [id])
  appliedPlatformFeeBps Int         // bps aplicados (1000 o 700)
  platformFeeAmount    BigInt       // Comisión Apapacho
  
  // Fee del procesador (si aplica)
  processorFeeAmount BigInt         @default(0)
  
  // Monto que recibe el creador
  creatorPayableAmount BigInt
  
  status          TransactionStatus @default(SUCCEEDED)
  occurredAt      DateTime          @default(now())
  
  // Proveedor de pagos
  provider        String            // "TRANSBANK", "FLOW", "MERCADOPAGO"
  providerPaymentId String
  providerEventId String            @unique // IDEMPOTENCIA
  
  // Metadata del pago
  metadata        Json              @default("{}")
  
  createdAt       DateTime          @default(now())
  
  // Relaciones
  ledgerEntries   LedgerEntry[]
  payoutItems     PayoutItem[]
  chargebacks     Chargeback[]

  @@index([creatorId, occurredAt(sort: Desc)])
  @@index([fanUserId])
  @@index([status])
  @@index([providerPaymentId])
}

// Catálogo de cuentas contables
model LedgerAccount {
  id    String @id @default(uuid())
  code  String @unique
  name  String
  type  String // "ASSET", "LIABILITY", "REVENUE", "EXPENSE"
  
  entries LedgerEntry[]
}

// Asientos contables (doble partida)
model LedgerEntry {
  id            String       @id @default(uuid())
  
  transactionId String?
  transaction   Transaction? @relation(fields: [transactionId], references: [id])
  
  payoutId      String?
  payout        Payout?      @relation(fields: [payoutId], references: [id])
  
  accountId     String
  account       LedgerAccount @relation(fields: [accountId], references: [id])
  
  // Creador asociado (null para cuentas globales como PLATFORM_REVENUE)
  creatorId     String?
  creator       Creator?     @relation(fields: [creatorId], references: [id])
  
  currency      String       @default("CLP")
  
  // Solo uno puede ser > 0 (validar en código)
  debit         BigInt       @default(0)
  credit        BigInt       @default(0)
  
  description   String?
  
  createdAt     DateTime     @default(now())

  @@index([transactionId])
  @@index([payoutId])
  @@index([creatorId, createdAt(sort: Desc)])
  @@index([accountId])
}

// Pagos a creadores
model Payout {
  id            String       @id @default(uuid())
  creatorId     String
  creator       Creator      @relation(fields: [creatorId], references: [id])
  
  periodStart   DateTime
  periodEnd     DateTime
  
  currency      String       @default("CLP")
  
  // Totales calculados
  grossTotal         BigInt  @default(0)
  platformFeeTotal   BigInt  @default(0)
  adjustmentsTotal   BigInt  @default(0)  // Refunds, chargebacks
  payoutAmount       BigInt  @default(0)  // Monto final a transferir
  
  status        PayoutStatus @default(CALCULATED)
  
  // Ejecución
  sentAt        DateTime?
  failedAt      DateTime?
  failureReason String?
  
  // Retry
  retryCount    Int          @default(0)
  nextRetryAt   DateTime?
  
  // Proveedor transferencia
  providerTransferId String?
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  items         PayoutItem[]
  ledgerEntries LedgerEntry[]

  @@index([creatorId, periodEnd(sort: Desc)])
  @@index([status])
  @@index([nextRetryAt])
}

// Detalle de transacciones incluidas en payout
model PayoutItem {
  id            String      @id @default(uuid())
  payoutId      String
  payout        Payout      @relation(fields: [payoutId], references: [id], onDelete: Cascade)
  
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  
  amount        BigInt
  createdAt     DateTime    @default(now())

  @@unique([payoutId, transactionId])
  @@index([transactionId])
}

// Contracargos
model Chargeback {
  id              String           @id @default(uuid())
  transactionId   String
  transaction     Transaction      @relation(fields: [transactionId], references: [id])
  
  provider        String
  providerCaseId  String           @unique  // IDEMPOTENCIA
  
  amount          BigInt
  reason          String?
  
  status          ChargebackStatus @default(RECEIVED)
  
  occurredAt      DateTime         @default(now())
  resolvedAt      DateTime?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([transactionId])
  @@index([status])
}

// Cola de eventos (Outbox Pattern)
model OutboxEvent {
  id            String    @id @default(uuid())
  
  aggregateType String    // "Transaction", "Payout", "Chargeback"
  aggregateId   String
  eventType     String    // "TransactionCreated", "PayoutCalculated", etc.
  
  payload       Json
  
  occurredAt    DateTime  @default(now())
  publishedAt   DateTime? // null = pendiente de publicar
  
  // Retry info
  attempts      Int       @default(0)
  lastError     String?

  @@index([publishedAt, occurredAt])
  @@index([aggregateType, aggregateId])
}
