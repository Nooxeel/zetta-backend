generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String         @id @default(uuid())
  email              String         @unique
  username           String         @unique
  password           String
  displayName        String
  avatar             String?
  bio                String?
  coverImage         String?
  backgroundColor    String         @default("#0f0f14")
  backgroundGradient String?
  accentColor        String         @default("#d946ef")
  fontFamily         String         @default("Inter")
  isCreator          Boolean        @default(false)
  // Age verification fields
  birthdate          DateTime?
  ageVerified        Boolean        @default(false)
  ageVerifiedAt      DateTime?
  ageVerificationIp  String?        // IP used for verification (for audit)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  comments           Comment[]
  creatorProfile     Creator?
  donationsSent      Donation[]
  favorites          Favorite[]
  subscriptions      Subscription[]
  // Conversations where user is participant1
  conversationsAsP1  Conversation[] @relation("Participant1")
  // Conversations where user is participant2
  conversationsAsP2  Conversation[] @relation("Participant2")
  // Messages sent by user
  messagesSent       Message[] @relation("MessagesSent")
  // Post interactions
  postLikes          PostLike[]
  postComments       PostComment[]
  // User interests
  interests          UserInterest[]
  // Points system
  userPoints         UserPoints?
  // Block system - users who blocked this user
  blockedBy          BlockedUser[] @relation("BlockedUser")
  // Referral system
  referralCode       String?       @unique // Unique code for this user to share
  referredBy         Referral?     @relation("ReferredUser")
  referrals          Referral[]    @relation("ReferrerUser")
  // Email verification
  emailVerified      Boolean       @default(false)
  emailVerifiedAt    DateTime?
  // Password reset tokens
  passwordResetTokens PasswordResetToken[]
  // Email verification tokens
  emailVerificationTokens EmailVerificationToken[]
  // Saved payment cards (Oneclick)
  savedCards         SavedCard[]
}

// Password Reset Token
model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

// Email Verification Token
model EmailVerificationToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

// Saved Card for Oneclick Recurring Payments
// Stores the tbkUser token from Transbank Oneclick inscription
model SavedCard {
  id              String    @id @default(uuid())
  userId          String
  tbkUser         String    @unique  // Transbank user token for charging
  cardType        String               // VISA, MASTERCARD, AMEX, etc.
  cardLastFour    String               // Last 4 digits for display (e.g., "1234")
  cardBrand       String?              // Débito/Crédito
  isDefault       Boolean   @default(false)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastUsedAt      DateTime?
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([tbkUser])
}

model Creator {
  id                 String               @id @default(uuid())
  userId             String               @unique
  bio                String?
  bioTitle           String               @default("Acerca de mí")
  extendedInfo       String?              // Información extendida/servicios (texto largo)
  extendedInfoTitle  String               @default("Información Adicional")
  profileImage       String?
  coverImage         String?
  backgroundColor    String               @default("#0f0f14")
  backgroundGradient String?
  backgroundImage    String?
  accentColor        String               @default("#d946ef")
  textColor          String               @default("#ffffff")
  fontFamily         String               @default("Inter")
  totalViews         Int                  @default(0)
  totalLikes         Int                  @default(0)
  isVerified         Boolean              @default(false)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  status             CreatorStatus        @default(ACTIVE)
  tier               CreatorTier          @default(STANDARD)
  // Configuración de visibilidad de secciones (JSON)
  visibilitySettings Json                 @default("{\"tabs\":{\"likes\":true,\"posts\":true,\"photos\":true,\"videos\":true,\"audio\":true,\"guestbook\":true,\"tipping\":true,\"postTipping\":true},\"messaging\":\"logged_in\"}")
  // Configuración de watermark (JSON)
  watermarkSettings  Json                 @default("{\"enabled\":false,\"text\":\"\",\"position\":\"bottom-right\",\"opacity\":0.7,\"size\":\"medium\"}")
  tierEffectiveFrom  DateTime             @default(now())
  comments           Comment[]
  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankAccounts       CreatorBankAccount[]
  tierHistory        CreatorTierHistory[]
  donationsReceived  Donation[]
  favoritedBy        Favorite[]
  ledgerEntries      LedgerEntry[]
  musicTracks        MusicTrack[]
  payouts            Payout[]
  posts              Post[]
  products           Product[]
  auditLogs          ProfileAuditLog[]
  socialLinks        SocialLink[]
  subscribers        Subscription[]
  subscriptionTiers  SubscriptionTier[]
  transactions       Transaction[]
  // Creator interests
  interests          CreatorInterest[]
  // Block system
  blockedUsers       BlockedUser[]
  // Promocodes
  promocodes         Promocode[]
  // Broadcasts / Mass DMs
  broadcasts         Broadcast[]
  // Platform imports
  platformImports    PlatformImport[]
}

model MusicTrack {
  id         String   @id @default(uuid())
  creatorId  String
  youtubeUrl String
  youtubeId  String
  title      String
  artist     String?
  thumbnail  String
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  creator    Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId])
}

model SocialLink {
  id        String   @id @default(uuid())
  creatorId String
  platform  String   // e.g., 'instagram', 'twitter', 'onlyfans', 'custom'
  url       String
  label     String?  // Custom label for the link
  icon      String?  // Custom icon emoji or name
  order     Int      @default(0)
  isVisible Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  creator   Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId, order])
  @@index([creatorId, isVisible])
}

model SubscriptionTier {
  id            String         @id @default(uuid())
  creatorId     String
  name          String
  description   String?
  price         Float
  currency      String         @default("USD")
  durationDays  Int            @default(30)
  benefits      String
  isActive      Boolean        @default(true)
  order         Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  subscriptions Subscription[]
  creator       Creator        @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId, isActive])
  @@index([creatorId, order])
}

model Subscription {
  id           String           @id @default(uuid())
  userId       String
  creatorId    String
  tierId       String
  status       String           @default("active")
  startDate    DateTime         @default(now())
  endDate      DateTime?
  autoRenew    Boolean          @default(true)
  savedCardId  String?          // Card used for auto-renewal (Oneclick)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  creator      Creator          @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  tier         SubscriptionTier @relation(fields: [tierId], references: [id])
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, creatorId])
  @@index([userId, status])
  @@index([creatorId, status])
  @@index([status])
}

model Post {
  id             String        @id @default(uuid())
  creatorId      String
  title          String?
  description    String?
  content        String
  visibility     String        @default("public")
  requiredTierId String?
  price          Float?
  likes          Int           @default(0)
  comments       Int           @default(0)
  views          Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  creator        Creator       @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  postLikes      PostLike[]
  postComments   PostComment[]

  @@index([creatorId, createdAt(sort: Desc)])
  @@index([creatorId, visibility])
}

model Donation {
  id              String   @id @default(uuid())
  fromUserId      String
  toCreatorId     String
  amount          Float
  currency        String   @default("USD")
  message         String?
  isAnonymous     Boolean  @default(false)
  platformFee     Float
  creatorEarnings Float
  status          String   @default("completed")
  createdAt       DateTime @default(now())
  fromUser        User     @relation(fields: [fromUserId], references: [id], onDelete: Cascade)
  toCreator       Creator  @relation(fields: [toCreatorId], references: [id], onDelete: Cascade)

  @@index([fromUserId])
  @@index([toCreatorId])
  @@index([toCreatorId, createdAt(sort: Desc)])
}

model ProfileAuditLog {
  id         String   @id @default(uuid())
  creatorId  String
  fieldName  String
  oldValue   String?
  newValue   String?
  changeType String   @default("update")
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  creator    Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId])
  @@index([fieldName])
  @@index([createdAt])
}

model Comment {
  id         String   @id @default(uuid())
  userId     String
  creatorId  String
  content    String
  isApproved Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  creator    Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([creatorId])
  @@index([userId])
  @@index([isApproved])
  @@index([createdAt])
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  creatorId String
  createdAt DateTime @default(now())
  creator   Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, creatorId])
  @@index([userId])
  @@index([creatorId])
}

model CreatorTierHistory {
  id            String      @id @default(uuid())
  creatorId     String
  previousTier  CreatorTier
  newTier       CreatorTier
  reason        String?
  changedBy     String?
  effectiveFrom DateTime    @default(now())
  createdAt     DateTime    @default(now())
  creator       Creator     @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId])
  @@index([effectiveFrom])
}

model FeeSchedule {
  id                     String          @id @default(uuid())
  effectiveFrom          DateTime
  standardPlatformFeeBps Int             @default(1000)
  vipPlatformFeeBps      Int             @default(700)
  holdDays               Int             @default(7)
  minPayoutClp           BigInt          @default(20000)
  payoutFrequency        PayoutFrequency @default(WEEKLY)
  description            String?
  createdBy              String?
  createdAt              DateTime        @default(now())
  transactions           Transaction[]

  @@index([effectiveFrom(sort: Desc)])
}

model CreatorBankAccount {
  id                String    @id @default(uuid())
  creatorId         String
  bankCode          String
  bankName          String
  accountType       String
  accountNumber     String
  accountHolderName String
  accountHolderRut  String
  isDefault         Boolean   @default(true)
  isVerified        Boolean   @default(false)
  verifiedAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?
  creator           Creator   @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId])
  @@index([isDefault])
}

model Product {
  id           String        @id @default(uuid())
  creatorId    String
  type         ProductType
  title        String?
  description  String?
  priceClp     BigInt
  metadata     Json          @default("{}")
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  deletedAt    DateTime?
  creator      Creator       @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([creatorId])
  @@index([type])
  @@index([isActive])
}

model Transaction {
  id                    String            @id @default(uuid())
  creatorId             String
  fanUserId             String
  productId             String?
  productType           ProductType
  currency              String            @default("CLP")
  grossAmount           BigInt
  appliedFeeScheduleId  String
  appliedPlatformFeeBps Int
  platformFeeAmount     BigInt
  processorFeeAmount    BigInt            @default(0)
  creatorPayableAmount  BigInt
  status                TransactionStatus @default(SUCCEEDED)
  occurredAt            DateTime          @default(now())
  provider              String
  providerPaymentId     String
  providerEventId       String            @unique
  metadata              Json              @default("{}")
  createdAt             DateTime          @default(now())
  chargebacks           Chargeback[]
  ledgerEntries         LedgerEntry[]
  payoutItems           PayoutItem[]
  appliedFeeSchedule    FeeSchedule       @relation(fields: [appliedFeeScheduleId], references: [id])
  creator               Creator           @relation(fields: [creatorId], references: [id])
  product               Product?          @relation(fields: [productId], references: [id])

  @@index([creatorId, occurredAt(sort: Desc)])
  @@index([fanUserId])
  @@index([status])
  @@index([providerPaymentId])
}

model LedgerAccount {
  id      String        @id @default(uuid())
  code    String        @unique
  name    String
  type    String
  entries LedgerEntry[]
}

model LedgerEntry {
  id            String        @id @default(uuid())
  transactionId String?
  payoutId      String?
  accountId     String
  creatorId     String?
  currency      String        @default("CLP")
  debit         BigInt        @default(0)
  credit        BigInt        @default(0)
  description   String?
  createdAt     DateTime      @default(now())
  account       LedgerAccount @relation(fields: [accountId], references: [id])
  creator       Creator?      @relation(fields: [creatorId], references: [id])
  payout        Payout?       @relation(fields: [payoutId], references: [id])
  transaction   Transaction?  @relation(fields: [transactionId], references: [id])

  @@index([transactionId])
  @@index([payoutId])
  @@index([creatorId, createdAt(sort: Desc)])
  @@index([accountId])
}

model Payout {
  id                 String        @id @default(uuid())
  creatorId          String
  periodStart        DateTime
  periodEnd          DateTime
  currency           String        @default("CLP")
  grossTotal         BigInt        @default(0)
  platformFeeTotal   BigInt        @default(0)
  adjustmentsTotal   BigInt        @default(0)
  payoutAmount       BigInt        @default(0)
  status             PayoutStatus  @default(CALCULATED)
  sentAt             DateTime?
  failedAt           DateTime?
  failureReason      String?
  retryCount         Int           @default(0)
  nextRetryAt        DateTime?
  providerTransferId String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  ledgerEntries      LedgerEntry[]
  creator            Creator       @relation(fields: [creatorId], references: [id])
  items              PayoutItem[]

  @@index([creatorId, periodEnd(sort: Desc)])
  @@index([status])
  @@index([nextRetryAt])
}

model PayoutItem {
  id            String      @id @default(uuid())
  payoutId      String
  transactionId String
  amount        BigInt
  createdAt     DateTime    @default(now())
  payout        Payout      @relation(fields: [payoutId], references: [id], onDelete: Cascade)
  transaction   Transaction @relation(fields: [transactionId], references: [id])

  @@unique([payoutId, transactionId])
  @@index([transactionId])
}

model Chargeback {
  id             String           @id @default(uuid())
  transactionId  String
  provider       String
  providerCaseId String           @unique
  amount         BigInt
  reason         String?
  status         ChargebackStatus @default(RECEIVED)
  occurredAt     DateTime         @default(now())
  resolvedAt     DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  transaction    Transaction      @relation(fields: [transactionId], references: [id])

  @@index([transactionId])
  @@index([status])
}

model OutboxEvent {
  id            String    @id @default(uuid())
  aggregateType String
  aggregateId   String
  eventType     String
  payload       Json
  publishedAt   DateTime?
  lastError     String?
  createdAt     DateTime  @default(now())
  retryCount    Int       @default(0)

  @@index([publishedAt, createdAt])
  @@index([aggregateType, aggregateId])
  @@index([retryCount])
}

enum CreatorTier {
  STANDARD
  VIP
}

enum CreatorStatus {
  ACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum ProductType {
  SUBSCRIPTION
  PPV
  TIP
}

enum TransactionStatus {
  SUCCEEDED
  REFUNDED
  CHARGEDBACK
  DISPUTED
}

enum PayoutStatus {
  CALCULATED
  PENDING
  SENT
  FAILED
  CANCELLED
}

enum PayoutFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum ChargebackStatus {
  RECEIVED
  WON
  LOST
  REVERSED
}

// ==================== MESSAGING SYSTEM ====================

model Conversation {
  id                 String    @id @default(uuid())
  participant1Id     String    // Always the one who initiated (usually fan)
  participant2Id     String    // The other participant (usually creator)
  lastMessageAt      DateTime  @default(now())
  participant1Unread Int       @default(0)
  participant2Unread Int       @default(0)
  // Status: active, archived, blocked
  status             String    @default("active")
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  
  participant1       User      @relation("Participant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2       User      @relation("Participant2", fields: [participant2Id], references: [id], onDelete: Cascade)
  messages           Message[]

  @@unique([participant1Id, participant2Id])
  @@index([participant1Id])
  @@index([participant2Id])
  @@index([lastMessageAt])
}

model Message {
  id             String    @id @default(uuid())
  conversationId String
  senderId       String
  content        String
  // Type: TEXT, IMAGE, VIDEO, TIP, PAID_CONTENT
  type           String    @default("TEXT")
  // For paid content messages
  price          Float?
  isPurchased    Boolean   @default(false)
  // Read tracking
  readAt         DateTime?
  // Soft delete
  deletedAt      DateTime?
  createdAt      DateTime  @default(now())
  
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

// ==================== POST INTERACTIONS ====================

model PostLike {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@index([createdAt])
}

model PostComment {
  id        String    @id @default(uuid())
  postId    String
  userId    String
  content   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
  @@index([createdAt])
  @@index([deletedAt])
}

// ==================== INTERESTS/TAGS SYSTEM ====================

model Interest {
  id          String            @id @default(uuid())
  slug        String            @unique
  name        String
  description String?
  icon        String?
  category    InterestCategory
  isNSFW      Boolean           @default(false)
  usageCount  Int               @default(0)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  userInterests    UserInterest[]
  creatorInterests CreatorInterest[]

  @@index([slug])
  @@index([category])
  @@index([usageCount(sort: Desc)])
}

model UserInterest {
  id         String   @id @default(uuid())
  userId     String
  interestId String
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  interest   Interest @relation(fields: [interestId], references: [id], onDelete: Cascade)

  @@unique([userId, interestId])
  @@index([userId])
  @@index([interestId])
}

model CreatorInterest {
  id         String   @id @default(uuid())
  creatorId  String
  interestId String
  createdAt  DateTime @default(now())

  creator    Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  interest   Interest @relation(fields: [interestId], references: [id], onDelete: Cascade)

  @@unique([creatorId, interestId])
  @@index([creatorId])
  @@index([interestId])
}

enum InterestCategory {
  CONTENT_TYPE
  AESTHETIC
  THEMES
  NICHE
}

// Roulette/Points System
model UserPoints {
  id                String   @id @default(uuid())
  userId            String   @unique
  points            Int      @default(1) // Users start with 1 point
  totalEarned       Int      @default(1)
  totalSpent        Int      @default(0)
  lastLoginDate     DateTime @default(now())
  loginStreak       Int      @default(1)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  history           PointsHistory[]
  rouletteSpins     RouletteSpin[]

  @@index([userId])
}

model PointsHistory {
  id          String   @id @default(uuid())
  userPointsId String
  amount      Int      // Positive for earned, negative for spent
  reason      String   // 'daily_login', 'roulette_win', 'roulette_spin', etc.
  createdAt   DateTime @default(now())

  userPoints  UserPoints @relation(fields: [userPointsId], references: [id], onDelete: Cascade)

  @@index([userPointsId])
  @@index([createdAt])
}

model RouletteSpin {
  id          String   @id @default(uuid())
  userPointsId String
  prizeId     Int      // 1-7, corresponds to prize configuration
  prizeLabel  String   // E.g., "10 Puntos", "Jackpot! 50 Puntos"
  pointsWon   Int      // Points won from this spin
  createdAt   DateTime @default(now())

  userPoints  UserPoints @relation(fields: [userPointsId], references: [id], onDelete: Cascade)

  @@index([userPointsId])
  @@index([createdAt])
}

// ==================== BLOCK SYSTEM ====================

model BlockedUser {
  id            String   @id @default(uuid())
  creatorId     String
  blockedUserId String
  reason        String?  // Razón opcional del bloqueo
  createdAt     DateTime @default(now())

  creator       Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  blockedUser   User     @relation("BlockedUser", fields: [blockedUserId], references: [id], onDelete: Cascade)

  @@unique([creatorId, blockedUserId])
  @@index([creatorId])
  @@index([blockedUserId])
}

// ==================== PROMOCODES SYSTEM ====================

model Promocode {
  id              String              @id @default(uuid())
  creatorId       String
  code            String              // Código (ej: WELCOME50)
  type            PromocodeType       // PERCENTAGE, FIXED_AMOUNT, FREE_TRIAL
  value           Float               // % descuento, monto fijo, o días de trial
  currency        String?             @default("CLP")
  maxUses         Int?                // null = ilimitado
  currentUses     Int                 @default(0)
  maxUsesPerUser  Int                 @default(1) // Máx usos por usuario
  minPurchase     Float?              // Mínimo de compra para aplicar
  applicableTiers String[]            // IDs de tiers donde aplica (vacío = todos)
  startsAt        DateTime            @default(now())
  expiresAt       DateTime?           // null = no expira
  isActive        Boolean             @default(true)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  creator         Creator             @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  redemptions     PromocodeRedemption[]

  @@unique([creatorId, code])
  @@index([code])
  @@index([creatorId, isActive])
  @@index([expiresAt])
}

model PromocodeRedemption {
  id              String      @id @default(uuid())
  promocodeId     String
  userId          String
  subscriptionId  String?     // Suscripción donde se aplicó
  originalAmount  Float       // Monto original
  discountAmount  Float       // Monto descontado
  finalAmount     Float       // Monto final pagado
  createdAt       DateTime    @default(now())

  promocode       Promocode   @relation(fields: [promocodeId], references: [id], onDelete: Cascade)

  @@index([promocodeId])
  @@index([userId])
  @@index([userId, promocodeId])
}

enum PromocodeType {
  PERCENTAGE      // Ej: 20% de descuento
  FIXED_AMOUNT    // Ej: $5000 de descuento
  FREE_TRIAL      // Ej: 7 días gratis
}

// ==================== MASS DM / BROADCAST SYSTEM ====================

model Broadcast {
  id              String              @id @default(uuid())
  creatorId       String
  content         String              // Mensaje de texto
  mediaUrl        String?             // URL de imagen/video opcional
  mediaType       String?             // 'image' | 'video'
  // Targeting
  targetType      BroadcastTarget     @default(ALL_SUBSCRIBERS)
  targetTierIds   String[]            // Para SPECIFIC_TIERS: IDs de tiers específicos
  // Status tracking
  status          BroadcastStatus     @default(PENDING)
  totalRecipients Int                 @default(0)
  sentCount       Int                 @default(0)
  failedCount     Int                 @default(0)
  // Scheduling
  scheduledFor    DateTime?           // null = enviar inmediatamente
  sentAt          DateTime?
  completedAt     DateTime?
  // Timestamps
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  creator         Creator             @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  recipients      BroadcastRecipient[]

  @@index([creatorId])
  @@index([status])
  @@index([scheduledFor])
  @@index([createdAt])
}

model BroadcastRecipient {
  id              String              @id @default(uuid())
  broadcastId     String
  userId          String
  conversationId  String?             // Conversation donde se envió
  messageId       String?             // Message creado
  status          BroadcastRecipientStatus @default(PENDING)
  sentAt          DateTime?
  error           String?
  createdAt       DateTime            @default(now())

  broadcast       Broadcast           @relation(fields: [broadcastId], references: [id], onDelete: Cascade)

  @@unique([broadcastId, userId])
  @@index([broadcastId])
  @@index([userId])
  @@index([status])
}

enum BroadcastTarget {
  ALL_SUBSCRIBERS     // Todos los suscriptores activos
  SPECIFIC_TIERS      // Solo suscriptores de tiers específicos
  NEW_SUBSCRIBERS     // Suscriptores en últimos 7 días
  EXPIRING_SOON       // Suscripciones por vencer (próximos 7 días)
}

enum BroadcastStatus {
  PENDING             // Creado, esperando envío
  SCHEDULED           // Programado para envío futuro
  PROCESSING          // En proceso de envío
  COMPLETED           // Enviado a todos
  FAILED              // Error en el proceso
  CANCELLED           // Cancelado por el creador
}

enum BroadcastRecipientStatus {
  PENDING             // Pendiente de enviar
  SENT                // Mensaje enviado
  FAILED              // Error al enviar
}

// =====================================
// REFERRAL PROGRAM MODELS
// =====================================

model Referral {
  id                String        @id @default(uuid())
  referrerId        String        // User who referred
  referredId        String        @unique // User who was referred (unique - can only be referred once)
  code              String        // Referral code used
  // Commission tracking
  commissionRate    Float         @default(0.05) // 5% default
  commissionEndDate DateTime      // When commission period ends (e.g., 3 months from signup)
  totalEarned       Float         @default(0)    // Total commission earned
  // Status
  status            ReferralStatus @default(PENDING)
  convertedAt       DateTime?     // When referred user made first purchase
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  referrer          User          @relation("ReferrerUser", fields: [referrerId], references: [id], onDelete: Cascade)
  referred          User          @relation("ReferredUser", fields: [referredId], references: [id], onDelete: Cascade)
  commissions       ReferralCommission[]

  @@index([referrerId])
  @@index([referredId])
  @@index([code])
  @@index([status])
}

model ReferralCommission {
  id            String   @id @default(uuid())
  referralId    String
  amount        Float    // Commission amount
  sourceType    String   // 'subscription' | 'donation' | 'product'
  sourceId      String?  // ID of the source transaction
  createdAt     DateTime @default(now())

  referral      Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)

  @@index([referralId])
  @@index([createdAt])
}

enum ReferralStatus {
  PENDING     // Referred user signed up but hasn't converted
  ACTIVE      // Referred user converted, earning commissions
  EXPIRED     // Commission period ended
  CANCELLED   // Referral cancelled
}

// =====================================
// PLATFORM IMPORT MODELS
// =====================================

model PlatformImport {
  id              String        @id @default(uuid())
  creatorId       String
  platform        ImportPlatform
  status          ImportStatus  @default(PENDING)
  // Import data (JSON with platform-specific data)
  importData      Json?
  // Statistics
  profileImported Boolean       @default(false)
  postsImported   Int           @default(0)
  mediaImported   Int           @default(0)
  errorsCount     Int           @default(0)
  errorLog        String?       // JSON array of errors
  // Timestamps
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  creator         Creator       @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId])
  @@index([status])
  @@index([platform])
}

enum ImportPlatform {
  ONLYFANS
  ARSMATE
  FANSLY
  OTHER
}

enum ImportStatus {
  PENDING         // Waiting to start
  PROCESSING      // Import in progress
  COMPLETED       // Successfully completed
  PARTIAL         // Completed with some errors
  FAILED          // Failed to import
  CANCELLED       // Cancelled by user
}

// ==================== WEBPAY PAYMENTS ====================

model WebpayTransaction {
  id                String               @id @default(uuid())
  
  // User and order info
  userId            String               // Who is paying
  buyOrder          String               @unique // Unique order identifier
  sessionId         String               // Session for tracking
  
  // Amount info
  amount            Int                  // Amount in CLP (integer, no decimals)
  
  // What they're paying for
  paymentType       WebpayPaymentType    // SUBSCRIPTION, DONATION, TIP, CONTENT
  
  // Related entities (optional, depends on paymentType)
  subscriptionTierId String?             // If paying for subscription
  creatorId          String?             // Creator receiving payment
  donationMessage    String?             // If it's a donation with message
  
  // Webpay specific fields
  token             String?              @unique // Token from Webpay
  returnUrl         String               // URL to redirect after payment
  
  // Transaction result (filled after commit)
  status            WebpayStatus         @default(PENDING)
  responseCode      Int?                 // 0 = approved
  authorizationCode String?              // Bank authorization code
  cardNumber        String?              // Last 4 digits (masked)
  cardType          String?              // VISA, MASTERCARD, etc
  paymentTypeCode   String?              // VD (debit), VN (credit), etc
  installmentsNumber Int?                // Number of installments
  transactionDate   DateTime?            // Webpay transaction date
  
  // Error handling
  errorMessage      String?
  
  // Timestamps
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  completedAt       DateTime?
  
  @@index([userId])
  @@index([status])
  @@index([buyOrder])
  @@index([creatorId])
}

enum WebpayPaymentType {
  SUBSCRIPTION      // Monthly subscription
  DONATION          // One-time donation/tip
  TIP               // Tip on content
  CONTENT           // Buying specific content
  TOKENS            // Buying platform tokens/credits
}

enum WebpayStatus {
  PENDING           // Transaction created, waiting for payment
  AUTHORIZED        // Payment authorized
  FAILED            // Payment failed
  CANCELLED         // User cancelled
  TIMEOUT           // User didn't complete in time
  REVERSED          // Payment was reversed
  REFUNDED          // Payment was refunded
}
