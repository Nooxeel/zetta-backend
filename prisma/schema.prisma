generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String         @id @default(uuid())
  email          String         @unique
  username       String         @unique
  password       String
  displayName    String
  avatar         String?
  isCreator      Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  comments       Comment[]
  creatorProfile Creator?
  donationsSent  Donation[]
  favorites      Favorite[]
  subscriptions  Subscription[]
  // Conversations where user is participant1
  conversationsAsP1  Conversation[] @relation("Participant1")
  // Conversations where user is participant2
  conversationsAsP2  Conversation[] @relation("Participant2")
  // Messages sent by user
  messagesSent       Message[] @relation("MessagesSent")
  // Post interactions
  postLikes          PostLike[]
  postComments       PostComment[]
  // User interests
  interests          UserInterest[]
}

model Creator {
  id                 String               @id @default(uuid())
  userId             String               @unique
  bio                String?
  profileImage       String?
  coverImage         String?
  backgroundColor    String               @default("#0f0f14")
  backgroundGradient String?
  backgroundImage    String?
  accentColor        String               @default("#d946ef")
  textColor          String               @default("#ffffff")
  fontFamily         String               @default("Inter")
  totalViews         Int                  @default(0)
  totalLikes         Int                  @default(0)
  isVerified         Boolean              @default(false)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  status             CreatorStatus        @default(ACTIVE)
  tier               CreatorTier          @default(STANDARD)
  // Configuraci√≥n de visibilidad de secciones (JSON)
  visibilitySettings Json                 @default("{\"tabs\":{\"likes\":true,\"posts\":true,\"photos\":true,\"videos\":true,\"audio\":true,\"guestbook\":true},\"messaging\":\"logged_in\"}")
  tierEffectiveFrom  DateTime             @default(now())
  comments           Comment[]
  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankAccounts       CreatorBankAccount[]
  tierHistory        CreatorTierHistory[]
  donationsReceived  Donation[]
  favoritedBy        Favorite[]
  ledgerEntries      LedgerEntry[]
  musicTracks        MusicTrack[]
  payouts            Payout[]
  posts              Post[]
  products           Product[]
  auditLogs          ProfileAuditLog[]
  socialLinks        SocialLink[]
  subscribers        Subscription[]
  subscriptionTiers  SubscriptionTier[]
  transactions       Transaction[]
  // Creator interests
  interests          CreatorInterest[]
}

model MusicTrack {
  id         String   @id @default(uuid())
  creatorId  String
  youtubeUrl String
  youtubeId  String
  title      String
  artist     String?
  thumbnail  String
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  creator    Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
}

model SocialLink {
  id        String   @id @default(uuid())
  creatorId String
  platform  String
  url       String
  label     String?
  createdAt DateTime @default(now())
  creator   Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
}

model SubscriptionTier {
  id            String         @id @default(uuid())
  creatorId     String
  name          String
  description   String?
  price         Float
  currency      String         @default("USD")
  benefits      String
  isActive      Boolean        @default(true)
  order         Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  subscriptions Subscription[]
  creator       Creator        @relation(fields: [creatorId], references: [id], onDelete: Cascade)
}

model Subscription {
  id        String           @id @default(uuid())
  userId    String
  creatorId String
  tierId    String
  status    String           @default("active")
  startDate DateTime         @default(now())
  endDate   DateTime?
  autoRenew Boolean          @default(true)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  creator   Creator          @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  tier      SubscriptionTier @relation(fields: [tierId], references: [id])
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, creatorId])
  @@index([userId, status])
  @@index([creatorId, status])
  @@index([status])
}

model Post {
  id             String        @id @default(uuid())
  creatorId      String
  title          String?
  description    String?
  content        String
  visibility     String        @default("public")
  requiredTierId String?
  price          Float?
  likes          Int           @default(0)
  comments       Int           @default(0)
  views          Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  creator        Creator       @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  postLikes      PostLike[]
  postComments   PostComment[]

  @@index([creatorId, createdAt(sort: Desc)])
  @@index([creatorId, visibility])
}

model Donation {
  id              String   @id @default(uuid())
  fromUserId      String
  toCreatorId     String
  amount          Float
  currency        String   @default("USD")
  message         String?
  isAnonymous     Boolean  @default(false)
  platformFee     Float
  creatorEarnings Float
  status          String   @default("completed")
  createdAt       DateTime @default(now())
  fromUser        User     @relation(fields: [fromUserId], references: [id], onDelete: Cascade)
  toCreator       Creator  @relation(fields: [toCreatorId], references: [id], onDelete: Cascade)
}

model ProfileAuditLog {
  id         String   @id @default(uuid())
  creatorId  String
  fieldName  String
  oldValue   String?
  newValue   String?
  changeType String   @default("update")
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  creator    Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId])
  @@index([fieldName])
  @@index([createdAt])
}

model Comment {
  id         String   @id @default(uuid())
  userId     String
  creatorId  String
  content    String
  isApproved Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  creator    Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([creatorId])
  @@index([userId])
  @@index([isApproved])
  @@index([createdAt])
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  creatorId String
  createdAt DateTime @default(now())
  creator   Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, creatorId])
  @@index([userId])
  @@index([creatorId])
}

model CreatorTierHistory {
  id            String      @id @default(uuid())
  creatorId     String
  previousTier  CreatorTier
  newTier       CreatorTier
  reason        String?
  changedBy     String?
  effectiveFrom DateTime    @default(now())
  createdAt     DateTime    @default(now())
  creator       Creator     @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId])
  @@index([effectiveFrom])
}

model FeeSchedule {
  id                     String          @id @default(uuid())
  effectiveFrom          DateTime
  standardPlatformFeeBps Int             @default(1000)
  vipPlatformFeeBps      Int             @default(700)
  holdDays               Int             @default(7)
  minPayoutClp           BigInt          @default(20000)
  payoutFrequency        PayoutFrequency @default(WEEKLY)
  description            String?
  createdBy              String?
  createdAt              DateTime        @default(now())
  transactions           Transaction[]

  @@index([effectiveFrom(sort: Desc)])
}

model CreatorBankAccount {
  id                String    @id @default(uuid())
  creatorId         String
  bankCode          String
  bankName          String
  accountType       String
  accountNumber     String
  accountHolderName String
  accountHolderRut  String
  isDefault         Boolean   @default(true)
  isVerified        Boolean   @default(false)
  verifiedAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?
  creator           Creator   @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId])
  @@index([isDefault])
}

model Product {
  id           String        @id @default(uuid())
  creatorId    String
  type         ProductType
  title        String?
  description  String?
  priceClp     BigInt
  metadata     Json          @default("{}")
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  deletedAt    DateTime?
  creator      Creator       @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([creatorId])
  @@index([type])
  @@index([isActive])
}

model Transaction {
  id                    String            @id @default(uuid())
  creatorId             String
  fanUserId             String
  productId             String?
  productType           ProductType
  currency              String            @default("CLP")
  grossAmount           BigInt
  appliedFeeScheduleId  String
  appliedPlatformFeeBps Int
  platformFeeAmount     BigInt
  processorFeeAmount    BigInt            @default(0)
  creatorPayableAmount  BigInt
  status                TransactionStatus @default(SUCCEEDED)
  occurredAt            DateTime          @default(now())
  provider              String
  providerPaymentId     String
  providerEventId       String            @unique
  metadata              Json              @default("{}")
  createdAt             DateTime          @default(now())
  chargebacks           Chargeback[]
  ledgerEntries         LedgerEntry[]
  payoutItems           PayoutItem[]
  appliedFeeSchedule    FeeSchedule       @relation(fields: [appliedFeeScheduleId], references: [id])
  creator               Creator           @relation(fields: [creatorId], references: [id])
  product               Product?          @relation(fields: [productId], references: [id])

  @@index([creatorId, occurredAt(sort: Desc)])
  @@index([fanUserId])
  @@index([status])
  @@index([providerPaymentId])
}

model LedgerAccount {
  id      String        @id @default(uuid())
  code    String        @unique
  name    String
  type    String
  entries LedgerEntry[]
}

model LedgerEntry {
  id            String        @id @default(uuid())
  transactionId String?
  payoutId      String?
  accountId     String
  creatorId     String?
  currency      String        @default("CLP")
  debit         BigInt        @default(0)
  credit        BigInt        @default(0)
  description   String?
  createdAt     DateTime      @default(now())
  account       LedgerAccount @relation(fields: [accountId], references: [id])
  creator       Creator?      @relation(fields: [creatorId], references: [id])
  payout        Payout?       @relation(fields: [payoutId], references: [id])
  transaction   Transaction?  @relation(fields: [transactionId], references: [id])

  @@index([transactionId])
  @@index([payoutId])
  @@index([creatorId, createdAt(sort: Desc)])
  @@index([accountId])
}

model Payout {
  id                 String        @id @default(uuid())
  creatorId          String
  periodStart        DateTime
  periodEnd          DateTime
  currency           String        @default("CLP")
  grossTotal         BigInt        @default(0)
  platformFeeTotal   BigInt        @default(0)
  adjustmentsTotal   BigInt        @default(0)
  payoutAmount       BigInt        @default(0)
  status             PayoutStatus  @default(CALCULATED)
  sentAt             DateTime?
  failedAt           DateTime?
  failureReason      String?
  retryCount         Int           @default(0)
  nextRetryAt        DateTime?
  providerTransferId String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  ledgerEntries      LedgerEntry[]
  creator            Creator       @relation(fields: [creatorId], references: [id])
  items              PayoutItem[]

  @@index([creatorId, periodEnd(sort: Desc)])
  @@index([status])
  @@index([nextRetryAt])
}

model PayoutItem {
  id            String      @id @default(uuid())
  payoutId      String
  transactionId String
  amount        BigInt
  createdAt     DateTime    @default(now())
  payout        Payout      @relation(fields: [payoutId], references: [id], onDelete: Cascade)
  transaction   Transaction @relation(fields: [transactionId], references: [id])

  @@unique([payoutId, transactionId])
  @@index([transactionId])
}

model Chargeback {
  id             String           @id @default(uuid())
  transactionId  String
  provider       String
  providerCaseId String           @unique
  amount         BigInt
  reason         String?
  status         ChargebackStatus @default(RECEIVED)
  occurredAt     DateTime         @default(now())
  resolvedAt     DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  transaction    Transaction      @relation(fields: [transactionId], references: [id])

  @@index([transactionId])
  @@index([status])
}

model OutboxEvent {
  id            String    @id @default(uuid())
  aggregateType String
  aggregateId   String
  eventType     String
  payload       Json
  publishedAt   DateTime?
  lastError     String?
  createdAt     DateTime  @default(now())
  retryCount    Int       @default(0)

  @@index([publishedAt, createdAt])
  @@index([aggregateType, aggregateId])
  @@index([retryCount])
}

enum CreatorTier {
  STANDARD
  VIP
}

enum CreatorStatus {
  ACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum ProductType {
  SUBSCRIPTION
  PPV
  TIP
}

enum TransactionStatus {
  SUCCEEDED
  REFUNDED
  CHARGEDBACK
  DISPUTED
}

enum PayoutStatus {
  CALCULATED
  PENDING
  SENT
  FAILED
  CANCELLED
}

enum PayoutFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum ChargebackStatus {
  RECEIVED
  WON
  LOST
  REVERSED
}

// ==================== MESSAGING SYSTEM ====================

model Conversation {
  id                 String    @id @default(uuid())
  participant1Id     String    // Always the one who initiated (usually fan)
  participant2Id     String    // The other participant (usually creator)
  lastMessageAt      DateTime  @default(now())
  participant1Unread Int       @default(0)
  participant2Unread Int       @default(0)
  // Status: active, archived, blocked
  status             String    @default("active")
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  
  participant1       User      @relation("Participant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2       User      @relation("Participant2", fields: [participant2Id], references: [id], onDelete: Cascade)
  messages           Message[]

  @@unique([participant1Id, participant2Id])
  @@index([participant1Id])
  @@index([participant2Id])
  @@index([lastMessageAt])
}

model Message {
  id             String    @id @default(uuid())
  conversationId String
  senderId       String
  content        String
  // Type: TEXT, IMAGE, VIDEO, TIP, PAID_CONTENT
  type           String    @default("TEXT")
  // For paid content messages
  price          Float?
  isPurchased    Boolean   @default(false)
  // Read tracking
  readAt         DateTime?
  // Soft delete
  deletedAt      DateTime?
  createdAt      DateTime  @default(now())
  
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

// ==================== POST INTERACTIONS ====================

model PostLike {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@index([createdAt])
}

model PostComment {
  id        String    @id @default(uuid())
  postId    String
  userId    String
  content   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
  @@index([createdAt])
  @@index([deletedAt])
}

// ==================== INTERESTS/TAGS SYSTEM ====================

model Interest {
  id          String            @id @default(uuid())
  slug        String            @unique
  name        String
  description String?
  icon        String?
  category    InterestCategory
  isNSFW      Boolean           @default(false)
  usageCount  Int               @default(0)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  userInterests    UserInterest[]
  creatorInterests CreatorInterest[]

  @@index([slug])
  @@index([category])
  @@index([usageCount(sort: Desc)])
}

model UserInterest {
  id         String   @id @default(uuid())
  userId     String
  interestId String
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  interest   Interest @relation(fields: [interestId], references: [id], onDelete: Cascade)

  @@unique([userId, interestId])
  @@index([userId])
  @@index([interestId])
}

model CreatorInterest {
  id         String   @id @default(uuid())
  creatorId  String
  interestId String
  createdAt  DateTime @default(now())

  creator    Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  interest   Interest @relation(fields: [interestId], references: [id], onDelete: Cascade)

  @@unique([creatorId, interestId])
  @@index([creatorId])
  @@index([interestId])
}

enum InterestCategory {
  CONTENT_TYPE
  AESTHETIC
  THEMES
  NICHE
}
