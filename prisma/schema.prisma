generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

/// Registry of SQL Server source databases known to the ETL system
model EtlSource {
  id        String   @id @default(cuid())
  dbName    String   @unique @map("db_name")
  label     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  syncedViews SyncedView[]

  @@map("etl_sources")
}

/// Tracks each SQL Server view that has been synced to PostgreSQL
model SyncedView {
  id                 String     @id @default(cuid())
  sourceId           String     @map("source_id")
  source             EtlSource  @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  sourceSchema       String     @map("source_schema")
  sourceView         String     @map("source_view")
  pgTableName        String     @map("pg_table_name")
  status             SyncStatus @default(NEVER_SYNCED)
  lastSyncAt         DateTime?  @map("last_sync_at")
  lastSyncRows       Int?       @map("last_sync_rows")
  lastSyncDurationMs Int?       @map("last_sync_duration_ms")
  lastError          String?    @map("last_error")
  schemaVersion      Int        @default(0) @map("schema_version")
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")

  columns  SyncedColumn[]
  syncLogs SyncLog[]

  @@unique([sourceId, sourceSchema, sourceView])
  @@map("synced_views")
}

enum SyncStatus {
  NEVER_SYNCED
  SYNCING
  SYNCED
  FAILED
  SCHEMA_CHANGED
}

/// Column mapping: tracks each column from the source view and its PG equivalent
model SyncedColumn {
  id               String     @id @default(cuid())
  syncedViewId     String     @map("synced_view_id")
  syncedView       SyncedView @relation(fields: [syncedViewId], references: [id], onDelete: Cascade)
  columnName       String     @map("column_name")
  sqlServerType    String     @map("sql_server_type")
  isNullable       Boolean    @map("is_nullable")
  ordinalPosition  Int        @map("ordinal_position")
  pgType           String     @map("pg_type")
  addedInVersion   Int        @default(0) @map("added_in_version")
  removedInVersion Int?       @map("removed_in_version")
  createdAt        DateTime   @default(now()) @map("created_at")

  @@unique([syncedViewId, columnName])
  @@map("synced_columns")
}

/// Audit log of every sync operation
model SyncLog {
  id            String        @id @default(cuid())
  syncedViewId  String        @map("synced_view_id")
  syncedView    SyncedView    @relation(fields: [syncedViewId], references: [id], onDelete: Cascade)
  status        SyncLogStatus
  rowsSynced    Int?          @map("rows_synced")
  durationMs    Int?          @map("duration_ms")
  error         String?
  schemaChanges String?       @map("schema_changes")
  startedAt     DateTime      @default(now()) @map("started_at")
  completedAt   DateTime?     @map("completed_at")

  @@index([syncedViewId, startedAt(sort: Desc)])
  @@map("sync_logs")
}

enum SyncLogStatus {
  STARTED
  COMPLETED
  FAILED
}

// ─── Authentication ─────────────────────────────────

enum Role {
  ADMIN
  BASIC
}

/// Google OAuth users with role-based access
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  image     String?
  googleId  String   @unique @map("google_id")
  role      Role     @default(BASIC)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}
